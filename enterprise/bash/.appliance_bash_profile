#!/bin/bash

# Session utils
alias reload='source ~/.bash_profile'
alias ls='ls -lhpA --group-directories-first --color=auto'
alias root='sudo su -l'

# Enterprise utils
alias gh.configs='gh.config.wrapper'
alias gh.secrets='gh.config.wrapper -s'

gh.config-apply () { sudo ghe-config-apply "$1"; }
gh.config-apply.system () { gh.config-apply --phase-1; }
gh.config-apply.migrations () { gh.config-apply --phase-2; }
gh.config-apply.applications () { gh.config-apply --phase-3; }
gh.config-apply.log () { tail -f /data/user/common/ghe-config.log; }

gh.config.wrapper () {

    local OPTIND

    while getopts "s" OPT; do
        case "$OPT" in
            s) KEY_PREFIX='secrets.';;
            ?) ;;
        esac
    done

    shift $((OPTIND -1))

    if [[ -z $1 ]]; then
        cat /data/user/common/${KEY_PREFIX-github.}conf
    else
        ghe-config --get-regexp "$KEY_PREFIX$1"
    fi
}

gh.s3.setup () {
    ghe-config 'secrets.packages.blob-storage-type' 's3'
    ghe-config 'secrets.packages.s3-region' "$REGISTRY_S3_REGION"
    ghe-config 'secrets.packages.s3-bucket' "$REGISTRY_S3_BUCKET"
    ghe-config 'secrets.packages.aws-secret-key' "$REGISTRY_S3_SECRET_KEY"
    ghe-config 'secrets.packages.aws-access-key' "$REGISTRY_S3_ACCESS_KEY"
    ghe-config 'secrets.packages.docker-enabled' 'true'
    ghe-config 'secrets.packages.maven-enabled' 'true'
    ghe-config 'secrets.packages.npm-enabled' 'true'
    ghe-config 'secrets.packages.rubygems-enabled' 'true'
    ghe-config 'secrets.packages.nuget-enabled' 'true'
    gh.config-apply.applications
}
